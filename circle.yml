machine:
  php:
    version: 7.0.6

environment:
  MAGE_VERSION: 2.0.7

dependencies:
  pre:
    - sed -i 's/^;//' ~/.phpenv/versions/$(phpenv global)/etc/conf.d/xdebug.ini
  override:
    - wget https://github.com/magento/magento2/archive/$MAGE_VERSION.zip
    - unzip -qq $MAGE_VERSION.zip
    - mkdir -p magento2-$MAGE_VERSION/app/code/Ebizmarts/SagePaySuite
    - cp -r Block Controller Helper Model Setup Test etc view registration.php magento2-$MAGE_VERSION/app/code/Ebizmarts/SagePaySuite
    - cd magento2-$MAGE_VERSION && wget https://gist.githubusercontent.com/centerax/5e42abec89d62a1308ba/raw/4b3242361c0690e234266afb3520c2940ac1055a/auth.json
    - cp phpunit_config.xml magento2-$MAGE_VERSION/dev/tests/unit/
    - cd magento2-$MAGE_VERSION && composer install --prefer-source --no-interaction

test:
  override:
    - magento2-$MAGE_VERSION/vendor/bin/phpunit -c magento2-$MAGE_VERSION/dev/tests/unit/phpunit_config.xml --coverage-text
  post:
    - cd magento2-$MAGE_VERSION && composer require --prefer-source --no-interaction "squizlabs/php_codesniffer=*" magento-ecg/coding-standard && vendor/squizlabs/php_codesniffer/scripts/phpcs --config-set installed_paths vendor/magento-ecg/coding-standard && ./vendor/squizlabs/php_codesniffer/scripts/phpcs -n --standard="EcgM2" ./app/code/Ebizmarts/SagePaySuite;
