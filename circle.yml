machine:
  services:
    - redis
  php:
    version: 7.0.7
  environment:
    MAGE_ROOT: /home/ubuntu/
    MAGE_VERSION: 2.1.6
    MARKETPLACE_EQP_VERSION: 1.0.5
    DB_URL: 127.0.0.1
    DB_NAME: circle_test
    DB_USER: ubuntu

  hosts:
    mage2.dev: 127.0.0.1

dependencies:
  pre:
    - echo "memory_limit = 768M" > /opt/circleci/php/7.0.7/etc/conf.d/memory.ini
    - echo "always_populate_raw_post_data = 1" > /opt/circleci/php/7.0.7/etc/conf.d/deprecated.ini
    - sudo apt-add-repository -y 'deb http://ppa.launchpad.net/ondrej/mysql-experimental/ubuntu precise main'
    - sudo apt-get update; sudo DEBIAN_FRONTEND=noninteractive apt-get install -y php5-curl apache2-mpm-prefork
  override:
    - cd .. && wget http://ebizmartsbackup.s3.amazonaws.com/Magento-EE-2.1.6_sample_data.tar.gz
    - cd .. && mkdir magento2-$MAGE_VERSION && cd magento2-$MAGE_VERSION && tar xzf ../Magento-EE-2.1.6_sample_data.tar.gz
    - cd ../magento2-$MAGE_VERSION && wget http://ebizmartsbackup.s3.amazonaws.com/phpunit-4.8.27.phar
    - chmod +x ../magento2-$MAGE_VERSION/phpunit-4.8.27.phar
    - cd ../magento2-$MAGE_VERSION && wget https://github.com/squizlabs/PHP_CodeSniffer/releases/download/2.7.1/phpcs.phar
    - cd ../magento2-$MAGE_VERSION && chmod +x phpcs.phar
    - cd ../magento2-$MAGE_VERSION && wget https://github.com/magento-ecg/coding-standard/archive/2.0.tar.gz && tar xzf 2.0.tar.gz
    - cd ../magento2-$MAGE_VERSION && chmod +x bin/magento && chmod -R 777 ./*
    - cd .. && wget https://github.com/magento/marketplace-eqp/archive/$MARKETPLACE_EQP_VERSION.zip
    - cd .. && unzip -qq $MARKETPLACE_EQP_VERSION.zip
    - echo "<?php return ['db-host'=>'127.0.0.1','db-user'=>'ubuntu','db-password'=>'','db-name'=>'circle_test','db-prefix'=>'int_','backend-frontname' => 'backend','admin-user' => 'admin',    'admin-password' => 'admin123',    'admin-email' => 'user@example.com', 'admin-firstname' => 'Admin', 'admin-lastname' => 'Admin'];" > ../magento2-$MAGE_VERSION/dev/tests/integration/etc/install-config-mysql.php
    - echo "<?php return ['language' => 'en_US', 'timezone' => 'America/Los_Angeles', 'currency' => 'USD', 'db-host'=>'127.0.0.1','db-user'=>'ubuntu','db-password'=>'','db-name'=>'circle_test','db-prefix'=>'int_','backend-frontname' => 'backend', 'base_url' => 'http://mage2.dev:8080/', 'use-secure' => '0', 'use-rewrites' => '0', 'admin-user' => 'admin',    'admin-password' => 'admin123', 'admin-email' => 'user@example.com',    'admin-firstname' => 'Admin','admin-lastname' => 'Admin', 'admin-use-security-key' => '0', 'sales-order-increment-prefix' => time(), 'session-save' => 'db', 'cleanup-database' => true,];" > ../magento2-$MAGE_VERSION/dev/tests/api-functional/config/install-config-mysql.php
    - echo "<?php return [];" > ../magento2-$MAGE_VERSION/dev/tests/api-functional/config/config-global.php
    - mkdir -p ../magento2-$MAGE_VERSION/app/code/Ebizmarts/SagePaySuite
    - cp -r ./* ../magento2-$MAGE_VERSION/app/code/Ebizmarts/SagePaySuite/
    - cd ../magento2-$MAGE_VERSION && wget https://gist.githubusercontent.com/centerax/5e42abec89d62a1308ba/raw/4b3242361c0690e234266afb3520c2940ac1055a/auth.json
    - cp phpunit_config.xml ../magento2-$MAGE_VERSION/dev/tests/unit/
    - cp phpunit_config_functional.xml ../magento2-$MAGE_VERSION/dev/tests/api-functional/phpunit.xml
    #- cp phpunit_config_integration.xml ../magento2-$MAGE_VERSION/dev/tests/integration/phpunit.xml
    - mkdir -p ../magento2-$MAGE_VERSION/dev/tests/integration/testsuite/Ebizmarts/SagePaySuite/_files
    - cp Test/Api/_files/* ../magento2-$MAGE_VERSION/dev/tests/integration/testsuite/Ebizmarts/SagePaySuite/_files
    - cd ../magento2-$MAGE_VERSION && composer install --prefer-source --no-interaction
    - cd ../magento2-$MAGE_VERSION && bin/magento setup:install --base-url=http://mage2.dev:8080/ --db-host=$DB_URL --db-name=$DB_NAME --db-user=$DB_USER --admin-firstname=Magento --admin-lastname=User --admin-email=user@example.com --admin-user=admin --admin-password=admin123 --language=en_US --currency=USD --timezone=America/Chicago --use-rewrites=1 --cleanup-database --use-sample-data
    - rm ../magento2-$MAGE_VERSION/app/etc/env.php
    - cd ../magento2-$MAGE_VERSION && wget https://gist.githubusercontent.com/centerax/f1ae700530a0112140011d846014eab9/raw/f5b8e32548b30bd1595671230657195a0b7bedd1/env.php -O app/etc/env.php
    - cd ../magento2-$MAGE_VERSION && bin/magento setup:upgrade
  post:
    - sudo wget https://gist.githubusercontent.com/centerax/80a1ef3a33b18aa998ebd9657a6057d4/raw/ef0674096f9bd37e79d9b4d60c43f541ab167888/mage2.dev.conf -O /etc/apache2/sites-available/mage2.dev.conf
    - sudo ln -s /etc/apache2/sites-available/mage2.dev.conf /etc/apache2/sites-enabled/mage2.dev.conf
    - sudo rm /etc/apache2/mods-enabled/php5.load
    - sudo service apache2 restart

test:
  override:
    - cd ../magento2-$MAGE_VERSION && ./phpcs.phar --config-set installed_paths coding-standard-2.0/ && ./phpcs.phar -n --standard="EcgM2" app/code/Ebizmarts/SagePaySuite;
    - cd ../magento2-$MAGE_VERSION && bin/magento setup:di:compile
    - cd ../magento2-$MAGE_VERSION && chmod -R 777 var/log
    - /opt/circleci/php/7.0.7/bin/php ../magento2-$MAGE_VERSION/phpunit-4.8.27.phar -c $MAGE_ROOT/magento2-$MAGE_VERSION/dev/tests/api-functional/phpunit.xml
    #- /opt/circleci/php/7.0.7/bin/php ../magento2-$MAGE_VERSION/phpunit-4.8.27.phar -c $MAGE_ROOT/magento2-$MAGE_VERSION/dev/tests/integration/phpunit.xml
    - ../magento2-$MAGE_VERSION/phpunit-4.8.27.phar -c ../magento2-$MAGE_VERSION/dev/tests/unit/phpunit_config.xml --coverage-text
    - cd ../magento2-$MAGE_VERSION && ../magento2-$MAGE_VERSION/phpcs.phar --config-set installed_paths $MAGE_ROOT/marketplace-eqp-$MARKETPLACE_EQP_VERSION && ../magento2-$MAGE_VERSION/phpcs.phar -n --standard="MEQP2" ../magento2-$MAGE_VERSION/app/code/Ebizmarts/SagePaySuite;
